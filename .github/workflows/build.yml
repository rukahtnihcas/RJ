name: Nuclear Reset Build
on:
  workflow_dispatch: # Manual Trigger Button

jobs:
  rebuild-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: ☢️ NUKE & REGENERATE PROJECT
        run: |
          # 1. DELETE EVERYTHING (Clean Slate)
          rm -rf app gradle settings.gradle build.gradle
          
          # 2. CREATE FOLDER STRUCTURE
          mkdir -p app/src/main/java/com/example/personaldj
          mkdir -p app/src/main/res/layout
          mkdir -p app/src/main/res/xml
          
          # 3. GENERATE ROOT BUILD.GRADLE
          cat <<EOF > build.gradle
          plugins {
              id 'com.android.application' version '8.2.0' apply false
              id 'org.jetbrains.kotlin.android' version '1.9.20' apply false
          }
          EOF

          # 4. GENERATE SETTINGS.GRADLE
          cat <<EOF > settings.gradle
          pluginManagement {
              repositories { google(); mavenCentral(); gradlePluginPortal() }
          }
          dependencyResolutionManagement {
              repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS)
              repositories { google(); mavenCentral() }
          }
          rootProject.name = "PersonalDJ"
          include ':app'
          EOF

          # 5. GENERATE APP BUILD.GRADLE
          cat <<EOF > app/build.gradle
          plugins {
              id 'com.android.application'
              id 'org.jetbrains.kotlin.android'
          }
          android {
              namespace 'com.example.personaldj'
              compileSdk 34
              defaultConfig {
                  applicationId "com.example.personaldj"
                  minSdk 24
                  targetSdk 34
                  versionCode 1
                  versionName "1.0"
              }
          }
          dependencies {
              implementation 'androidx.core:core-ktx:1.12.0'
              implementation 'androidx.appcompat:appcompat:1.6.1'
              implementation 'com.google.android.material:material:1.11.0'
              implementation 'androidx.constraintlayout:constraintlayout:2.1.4'
              implementation "androidx.media3:media3-exoplayer:1.2.0"
              implementation "androidx.media3:media3-session:1.2.0"
          }
          EOF

          # 6. GENERATE MANIFEST
          cat <<EOF > app/src/main/AndroidManifest.xml
          <?xml version="1.0" encoding="utf-8"?>
          <manifest xmlns:android="http://schemas.android.com/apk/res/android"
              xmlns:tools="http://schemas.android.com/tools">
              <uses-permission android:name="android.permission.FOREGROUND_SERVICE"/>
              <uses-permission android:name="android.permission.FOREGROUND_SERVICE_MEDIA_PLAYBACK"/>
              <application
                  android:label="Personal DJ"
                  android:theme="@style/Theme.AppCompat.Light.NoActionBar">
                  <activity android:name=".MainActivity" android:exported="true">
                      <intent-filter>
                          <action android:name="android.intent.action.MAIN" />
                          <category android:name="android.intent.category.LAUNCHER" />
                      </intent-filter>
                  </activity>
                  <service android:name=".DJRadioService" android:foregroundServiceType="mediaPlayback" android:exported="false"/>
              </application>
          </manifest>
          EOF

          # 7. GENERATE KOTLIN CODE (Combined File)
          cat <<EOF > app/src/main/java/com/example/personaldj/MainActivity.kt
          package com.example.personaldj
          import android.app.Service
          import android.content.ComponentName
          import android.content.Context
          import android.content.Intent
          import android.content.ServiceConnection
          import android.os.Bundle
          import android.os.IBinder
          import android.speech.tts.TextToSpeech
          import android.view.Gravity
          import android.widget.Button
          import android.widget.TextView
          import androidx.appcompat.app.AppCompatActivity
          import androidx.media3.common.MediaItem
          import androidx.media3.exoplayer.ExoPlayer
          import java.util.Locale

          class MainActivity : AppCompatActivity() {
              private val connection = object : ServiceConnection {
                  override fun onServiceConnected(n: ComponentName, s: IBinder) {}
                  override fun onServiceDisconnected(n: ComponentName) {}
              }
              override fun onCreate(savedInstanceState: Bundle?) {
                  super.onCreate(savedInstanceState)
                  val btn = Button(this).apply {
                      text = "Start Radio"
                      setOnClickListener {
                          val i = Intent(this@MainActivity, DJRadioService::class.java)
                          startService(i)
                          bindService(i, connection, Context.BIND_AUTO_CREATE)
                      }
                  }
                  setContentView(btn)
              }
          }

          class DJRadioService : Service(), TextToSpeech.OnInitListener {
              private lateinit var player: ExoPlayer
              private lateinit var tts: TextToSpeech
              inner class LocalBinder : android.os.Binder()
              override fun onBind(i: Intent?): IBinder = LocalBinder()
              override fun onCreate() {
                  super.onCreate()
                  tts = TextToSpeech(this, this)
                  player = ExoPlayer.Builder(this).build()
                  val item = MediaItem.fromUri("https://storage.googleapis.com/exoplayer-test-media-0/Jazz_In_Paris.mp3")
                  player.addMediaItem(item)
                  player.prepare()
                  player.play()
              }
              override fun onInit(s: Int) {
                  if (s == TextToSpeech.SUCCESS) tts.language = Locale.US
              }
          }
          EOF

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Build APK
        run: gradle assembleDebug --no-daemon --stacktrace

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: nuclear-dj-app
          path: app/build/outputs/apk/debug/app-debug.apk
          
