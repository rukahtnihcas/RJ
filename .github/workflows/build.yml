name: Self-Healing Build
on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  fix-and-build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: üöë Auto-Repair Project Structure
        run: |
          echo "Starting Auto-Repair..."
          
          # 1. Create the correct directory skeleton (forcing it to exist)
          mkdir -p app/src/main/java/com/example/personaldj
          mkdir -p app/src/main/res/layout
          
          # 2. Hunt for MainActivity.kt (Case insensitive) and move it
          # We use 'find' to locate it anywhere in the repo and move it to the right spot
          find . -type f -iname "MainActivity.kt" -not -path "*/com/example/personaldj/*" -exec mv -v {} app/src/main/java/com/example/personaldj/ \; || true
          
          # 3. Hunt for DJRadioService.kt and move it
          find . -type f -iname "DJRadioService.kt" -not -path "*/com/example/personaldj/*" -exec mv -v {} app/src/main/java/com/example/personaldj/ \; || true
          
          # 4. Hunt for Manifest and Layouts
          find . -type f -iname "AndroidManifest.xml" -not -path "*/app/src/main/*" -exec mv -v {} app/src/main/ \; || true
          find . -type f -iname "activity_main.xml" -not -path "*/layout/*" -exec mv -v {} app/src/main/res/layout/ \; || true
          
          echo "Repair complete. File structure:"
          find app -maxdepth 5

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: üõ†Ô∏è Force Build (No Daemon)
        # We skip the 'clean' task to save time and use generic 'assembleDebug'
        run: gradle assembleDebug --no-daemon --stacktrace

      - name: üì¶ Upload APK
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: personal-dj-app
          path: app/build/outputs/apk/debug/app-debug.apk
          
